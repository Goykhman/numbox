

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>numbox.utils.lowlevel &mdash; numbox  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=9edc463e" />

  
    <link rel="canonical" href="https://goykhman.github.io/numbox/_modules/numbox/utils/lowlevel.html" />
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            numbox
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">numbox</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">numbox</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">numbox.utils.lowlevel</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for numbox.utils.lowlevel</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span><span class="w"> </span><span class="nn">importlib.metadata</span><span class="w"> </span><span class="kn">import</span> <span class="n">version</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">llvmlite</span><span class="w"> </span><span class="kn">import</span> <span class="n">ir</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">llvmlite.ir.builder</span><span class="w"> </span><span class="kn">import</span> <span class="n">IRBuilder</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">numba</span><span class="w"> </span><span class="kn">import</span> <span class="n">carray</span><span class="p">,</span> <span class="n">njit</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">numba.core.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseContext</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">numba.core.cgutils</span><span class="w"> </span><span class="kn">import</span> <span class="n">int32_t</span><span class="p">,</span> <span class="n">intp_t</span><span class="p">,</span> <span class="n">is_not_null</span> <span class="k">as</span> <span class="n">cgutils_is_not_null</span><span class="p">,</span> <span class="n">pack_array</span><span class="p">,</span> <span class="n">voidptr_t</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">numba.experimental.jitclass.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">imp_dtor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">numba.experimental.structref</span><span class="w"> </span><span class="kn">import</span> <span class="n">_Utils</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">numba.core.types</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">boolean</span><span class="p">,</span> <span class="n">FunctionType</span><span class="p">,</span> <span class="n">intp</span><span class="p">,</span> <span class="n">StructRef</span><span class="p">,</span> <span class="n">TypeRef</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">char</span><span class="p">,</span>
    <span class="n">UnicodeType</span><span class="p">,</span> <span class="n">unicode_type</span><span class="p">,</span> <span class="n">uintp</span><span class="p">,</span> <span class="n">UniTuple</span><span class="p">,</span> <span class="n">voidptr</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">numba.core.typing.context</span><span class="w"> </span><span class="kn">import</span> <span class="n">Context</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">numba.extending</span><span class="w"> </span><span class="kn">import</span> <span class="n">intrinsic</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">numbox.core.configurations</span><span class="w"> </span><span class="kn">import</span> <span class="n">default_jit_options</span><span class="p">,</span> <span class="n">MAX_STR_LENGTH</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">numbox.utils.void_type</span><span class="w"> </span><span class="kn">import</span> <span class="n">VoidType</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">numbox.utils.highlevel</span><span class="w"> </span><span class="kn">import</span> <span class="n">determine_field_index</span>


<span class="n">numba_version</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">version</span><span class="p">(</span><span class="s2">&quot;numba&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
<span class="k">assert</span> <span class="n">numba_version</span> <span class="o">&gt;=</span> <span class="mi">60</span><span class="p">,</span> <span class="n">numba_version</span>
<span class="n">function_struct_size</span> <span class="o">=</span> <span class="mi">3</span> <span class="k">if</span> <span class="n">numba_version</span> <span class="o">&gt;=</span> <span class="mi">61</span> <span class="k">else</span> <span class="mi">2</span>  <span class="c1"># See `FunctionModel` struct (c_addr, py_addr[, jit_addr])</span>


<span class="nd">@intrinsic</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_cast</span><span class="p">(</span><span class="n">typingctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span> <span class="n">source_ty</span><span class="p">,</span> <span class="n">dest_ty_ref</span><span class="p">:</span> <span class="n">TypeRef</span><span class="p">):</span>
    <span class="n">dest_ty</span> <span class="o">=</span> <span class="n">dest_ty_ref</span><span class="o">.</span><span class="n">instance_type</span>
    <span class="n">sig</span> <span class="o">=</span> <span class="n">dest_ty</span><span class="p">(</span><span class="n">source_ty</span><span class="p">,</span> <span class="n">dest_ty_ref</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">codegen</span><span class="p">(</span><span class="n">context</span><span class="p">:</span> <span class="n">BaseContext</span><span class="p">,</span> <span class="n">builder</span><span class="p">,</span> <span class="n">signature</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="n">source_ty_ll</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get_data_type</span><span class="p">(</span><span class="n">source_ty</span><span class="p">)</span>
        <span class="n">dest_ty_ll</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get_data_type</span><span class="p">(</span><span class="n">dest_ty</span><span class="p">)</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">builder</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">source_ty_ll</span><span class="p">,</span> <span class="n">dest_ty_ll</span><span class="p">)</span>
        <span class="n">context</span><span class="o">.</span><span class="n">nrt</span><span class="o">.</span><span class="n">incref</span><span class="p">(</span><span class="n">builder</span><span class="p">,</span> <span class="n">dest_ty</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">val</span>
    <span class="k">return</span> <span class="n">sig</span><span class="p">,</span> <span class="n">codegen</span>


<div class="viewcode-block" id="cast">
<a class="viewcode-back" href="../../../numbox.utils.html#numbox.utils.lowlevel.cast">[docs]</a>
<span class="nd">@njit</span><span class="p">(</span><span class="o">**</span><span class="n">default_jit_options</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">cast</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">dest_ty</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Cast `source` to the type `dest_ty` &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_cast</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">dest_ty</span><span class="p">)</span></div>



<span class="nd">@intrinsic</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_cast_int_to_void_p</span><span class="p">(</span><span class="n">typingctx</span><span class="p">,</span> <span class="n">p_ty</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Cast 64-bit integer to void pointer type &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">codegen</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">builder</span><span class="p">,</span> <span class="n">signature</span><span class="p">,</span> <span class="n">arguments</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">builder</span><span class="o">.</span><span class="n">inttoptr</span><span class="p">(</span><span class="n">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">voidptr_t</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">voidptr</span><span class="p">(</span><span class="n">p_ty</span><span class="p">),</span> <span class="n">codegen</span>


<span class="nd">@intrinsic</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_deref_payload</span><span class="p">(</span><span class="n">typingctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span> <span class="n">struct_ty</span><span class="p">,</span> <span class="n">ty_ref</span><span class="p">:</span> <span class="n">TypeRef</span><span class="p">):</span>
    <span class="n">ty</span> <span class="o">=</span> <span class="n">ty_ref</span><span class="o">.</span><span class="n">instance_type</span>
    <span class="n">sig</span> <span class="o">=</span> <span class="n">ty</span><span class="p">(</span><span class="n">struct_ty</span><span class="p">,</span> <span class="n">ty_ref</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">codegen</span><span class="p">(</span><span class="n">context</span><span class="p">:</span> <span class="n">BaseContext</span><span class="p">,</span> <span class="n">builder</span><span class="p">,</span> <span class="n">signature</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="n">ty_ll</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get_data_type</span><span class="p">(</span><span class="n">ty</span><span class="p">)</span>
        <span class="n">struct_</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">meminfo_p</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">nrt</span><span class="o">.</span><span class="n">get_meminfos</span><span class="p">(</span><span class="n">builder</span><span class="p">,</span> <span class="n">struct_ty</span><span class="p">,</span> <span class="n">struct_</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">payload_p</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">nrt</span><span class="o">.</span><span class="n">meminfo_data</span><span class="p">(</span><span class="n">builder</span><span class="p">,</span> <span class="n">meminfo_p</span><span class="p">)</span>
        <span class="n">x_as_ty_p</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">bitcast</span><span class="p">(</span><span class="n">payload_p</span><span class="p">,</span> <span class="n">ty_ll</span><span class="o">.</span><span class="n">as_pointer</span><span class="p">())</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">x_as_ty_p</span><span class="p">)</span>
        <span class="n">context</span><span class="o">.</span><span class="n">nrt</span><span class="o">.</span><span class="n">incref</span><span class="p">(</span><span class="n">builder</span><span class="p">,</span> <span class="n">ty</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">val</span>
    <span class="k">return</span> <span class="n">sig</span><span class="p">,</span> <span class="n">codegen</span>


<div class="viewcode-block" id="deref_payload">
<a class="viewcode-back" href="../../../numbox.utils.html#numbox.utils.lowlevel.deref_payload">[docs]</a>
<span class="nd">@njit</span><span class="p">(</span><span class="o">**</span><span class="n">default_jit_options</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">deref_payload</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">ty</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Dereference payload of structref `p` as type `ty` &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_deref_payload</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">ty</span><span class="p">)</span></div>



<div class="viewcode-block" id="extract_struct_member">
<a class="viewcode-back" href="../../../numbox.utils.html#numbox.utils.lowlevel.extract_struct_member">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">extract_struct_member</span><span class="p">(</span>
    <span class="n">context</span><span class="p">:</span> <span class="n">BaseContext</span><span class="p">,</span>
    <span class="n">builder</span><span class="p">:</span> <span class="n">IRBuilder</span><span class="p">,</span>
    <span class="n">struct_fe_ty</span><span class="p">:</span> <span class="n">StructRef</span><span class="p">,</span>
    <span class="n">struct_obj</span><span class="p">,</span>
    <span class="n">member_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">incref</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; For the given struct object of the given numba (front-end) type extract</span>
<span class="sd">    member with the given name (must be literal, available at compile time) &quot;&quot;&quot;</span>
    <span class="n">member_ty</span> <span class="o">=</span> <span class="n">struct_fe_ty</span><span class="o">.</span><span class="n">field_dict</span><span class="p">[</span><span class="n">member_name</span><span class="p">]</span>
    <span class="n">payload_ty</span> <span class="o">=</span> <span class="n">struct_fe_ty</span><span class="o">.</span><span class="n">get_data_type</span><span class="p">()</span>
    <span class="n">meminfo</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">nrt</span><span class="o">.</span><span class="n">get_meminfos</span><span class="p">(</span><span class="n">builder</span><span class="p">,</span> <span class="n">struct_fe_ty</span><span class="p">,</span> <span class="n">struct_obj</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">meminfo_p</span> <span class="o">=</span> <span class="n">meminfo</span>
    <span class="n">payload_p</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">nrt</span><span class="o">.</span><span class="n">meminfo_data</span><span class="p">(</span><span class="n">builder</span><span class="p">,</span> <span class="n">meminfo_p</span><span class="p">)</span>
    <span class="n">payload_ty_ll</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get_data_type</span><span class="p">(</span><span class="n">payload_ty</span><span class="p">)</span>
    <span class="n">payload_ty_p_ll</span> <span class="o">=</span> <span class="n">payload_ty_ll</span><span class="o">.</span><span class="n">as_pointer</span><span class="p">()</span>
    <span class="n">payload_p</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">bitcast</span><span class="p">(</span><span class="n">payload_p</span><span class="p">,</span> <span class="n">payload_ty_p_ll</span><span class="p">)</span>
    <span class="n">member_ind</span> <span class="o">=</span> <span class="n">determine_field_index</span><span class="p">(</span><span class="n">struct_fe_ty</span><span class="p">,</span> <span class="n">member_name</span><span class="p">)</span>
    <span class="n">data_p</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">gep</span><span class="p">(</span><span class="n">payload_p</span><span class="p">,</span> <span class="p">(</span><span class="n">int32_t</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">int32_t</span><span class="p">(</span><span class="n">member_ind</span><span class="p">)))</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">data_p</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">incref</span><span class="p">:</span>
        <span class="n">context</span><span class="o">.</span><span class="n">nrt</span><span class="o">.</span><span class="n">incref</span><span class="p">(</span><span class="n">builder</span><span class="p">,</span> <span class="n">member_ty</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data</span></div>



<div class="viewcode-block" id="get_func_p_from_func_struct">
<a class="viewcode-back" href="../../../numbox.utils.html#numbox.utils.lowlevel.get_func_p_from_func_struct">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_func_p_from_func_struct</span><span class="p">(</span><span class="n">builder</span><span class="p">:</span> <span class="n">IRBuilder</span><span class="p">,</span> <span class="n">func_struct</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Extract void* function pointer from the low-level FunctionType structure &quot;&quot;&quot;</span>
    <span class="n">func_raw_p_ind</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">builder</span><span class="o">.</span><span class="n">extract_value</span><span class="p">(</span><span class="n">func_struct</span><span class="p">,</span> <span class="n">func_raw_p_ind</span><span class="p">)</span></div>



<span class="nd">@intrinsic</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_get_func_p_as_int_from_func_struct</span><span class="p">(</span><span class="n">typingctx</span><span class="p">,</span> <span class="n">func_ty</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">codegen</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">builder</span><span class="p">,</span> <span class="n">signature</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">builder</span><span class="o">.</span><span class="n">ptrtoint</span><span class="p">(</span><span class="n">get_func_p_from_func_struct</span><span class="p">(</span><span class="n">builder</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">intp_t</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">intp</span><span class="p">(</span><span class="n">func_ty</span><span class="p">),</span> <span class="n">codegen</span>


<div class="viewcode-block" id="get_func_p_as_int_from_func_struct">
<a class="viewcode-back" href="../../../numbox.utils.html#numbox.utils.lowlevel.get_func_p_as_int_from_func_struct">[docs]</a>
<span class="nd">@njit</span><span class="p">(</span><span class="o">**</span><span class="n">default_jit_options</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_func_p_as_int_from_func_struct</span><span class="p">(</span><span class="n">func_</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">_get_func_p_as_int_from_func_struct</span><span class="p">(</span><span class="n">func_</span><span class="p">)</span></div>



<span class="nd">@intrinsic</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_get_func_tuple</span><span class="p">(</span><span class="n">typingctx</span><span class="p">,</span> <span class="n">func_ty</span><span class="p">):</span>
    <span class="n">return_tuple_type</span> <span class="o">=</span> <span class="n">UniTuple</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">function_struct_size</span><span class="p">)</span>
    <span class="n">sig</span> <span class="o">=</span> <span class="n">return_tuple_type</span><span class="p">(</span><span class="n">func_ty</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">codegen</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">builder</span><span class="p">,</span> <span class="n">signature</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="n">func_struct</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">lst</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">function_struct_size</span><span class="p">):</span>
            <span class="n">lst</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">builder</span><span class="o">.</span><span class="n">ptrtoint</span><span class="p">(</span><span class="n">builder</span><span class="o">.</span><span class="n">extract_value</span><span class="p">(</span><span class="n">func_struct</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span> <span class="n">intp_t</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">context</span><span class="o">.</span><span class="n">make_tuple</span><span class="p">(</span><span class="n">builder</span><span class="p">,</span> <span class="n">return_tuple_type</span><span class="p">,</span> <span class="n">lst</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sig</span><span class="p">,</span> <span class="n">codegen</span>


<div class="viewcode-block" id="get_func_tuple">
<a class="viewcode-back" href="../../../numbox.utils.html#numbox.utils.lowlevel.get_func_tuple">[docs]</a>
<span class="nd">@njit</span><span class="p">(</span><span class="o">**</span><span class="n">default_jit_options</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_func_tuple</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">_get_func_tuple</span><span class="p">(</span><span class="n">func</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_ll_func_sig">
<a class="viewcode-back" href="../../../numbox.utils.html#numbox.utils.lowlevel.get_ll_func_sig">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_ll_func_sig</span><span class="p">(</span><span class="n">context</span><span class="p">:</span> <span class="n">BaseContext</span><span class="p">,</span> <span class="n">func_ty</span><span class="p">:</span> <span class="n">FunctionType</span><span class="p">):</span>
    <span class="n">func_sig</span> <span class="o">=</span> <span class="n">func_ty</span><span class="o">.</span><span class="n">signature</span>
    <span class="n">arg_types</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">func_sig</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">arg_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">get_data_type</span><span class="p">(</span><span class="n">arg</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">ir</span><span class="o">.</span><span class="n">FunctionType</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">get_data_type</span><span class="p">(</span><span class="n">func_sig</span><span class="o">.</span><span class="n">return_type</span><span class="p">),</span> <span class="n">arg_types</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_str_from_p_as_int">
<a class="viewcode-back" href="../../../numbox.utils.html#numbox.utils.lowlevel.get_str_from_p_as_int">[docs]</a>
<span class="nd">@njit</span><span class="p">(</span><span class="n">unicode_type</span><span class="p">(</span><span class="n">intp</span><span class="p">),</span> <span class="o">**</span><span class="n">default_jit_options</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_str_from_p_as_int</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Given pointer to null-terminated array of characters as an integer `p`,</span>
<span class="sd">    return unicode string object copying the original string&#39;s data &quot;&quot;&quot;</span>
    <span class="n">void_p</span> <span class="o">=</span> <span class="n">_cast_int_to_void_p</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">mem_view</span> <span class="o">=</span> <span class="n">carray</span><span class="p">(</span><span class="n">void_p</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">MAX_STR_LENGTH</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">char</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">char_as_code_p</span> <span class="ow">in</span> <span class="n">mem_view</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">char_as_code_p</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">s</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">char_as_code_p</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">s</span></div>



<span class="nd">@intrinsic</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_get_unicode_data_p</span><span class="p">(</span><span class="n">typingctx</span><span class="p">,</span> <span class="n">str_ty</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">codegen</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">builder</span><span class="p">,</span> <span class="n">signature</span><span class="p">,</span> <span class="n">arguments</span><span class="p">):</span>
        <span class="n">str_</span> <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">meminfo</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">nrt</span><span class="o">.</span><span class="n">get_meminfos</span><span class="p">(</span><span class="n">builder</span><span class="p">,</span> <span class="n">unicode_type</span><span class="p">,</span> <span class="n">str_</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">meminfo_p</span> <span class="o">=</span> <span class="n">meminfo</span>
        <span class="n">payload_p</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">nrt</span><span class="o">.</span><span class="n">meminfo_data</span><span class="p">(</span><span class="n">builder</span><span class="p">,</span> <span class="n">meminfo_p</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">builder</span><span class="o">.</span><span class="n">ptrtoint</span><span class="p">(</span><span class="n">payload_p</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">get_data_type</span><span class="p">(</span><span class="n">intp</span><span class="p">))</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">str_ty</span><span class="p">,</span> <span class="n">UnicodeType</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">intp</span><span class="p">(</span><span class="n">str_ty</span><span class="p">),</span> <span class="n">codegen</span>


<div class="viewcode-block" id="get_unicode_data_p">
<a class="viewcode-back" href="../../../numbox.utils.html#numbox.utils.lowlevel.get_unicode_data_p">[docs]</a>
<span class="nd">@njit</span><span class="p">(</span><span class="o">**</span><span class="n">default_jit_options</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_unicode_data_p</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Given Python unicode string, return pointer to its data payload,</span>
<span class="sd">    array of null-terminated characters.</span>
<span class="sd">    See https://github.com/numba/numba/blob/release0.61/numba/cpython/unicode.py#L83</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_get_unicode_data_p</span><span class="p">(</span><span class="n">s</span><span class="p">)</span></div>



<span class="nd">@intrinsic</span>
<span class="k">def</span><span class="w"> </span><span class="nf">is_not_null</span><span class="p">(</span><span class="n">typingctx</span><span class="p">,</span> <span class="n">struct_ty</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">codegen</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">builder</span><span class="p">,</span> <span class="n">signature</span><span class="p">,</span> <span class="n">arguments</span><span class="p">):</span>
        <span class="n">struct_</span> <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">meminfo</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">nrt</span><span class="o">.</span><span class="n">get_meminfos</span><span class="p">(</span><span class="n">builder</span><span class="p">,</span> <span class="n">struct_ty</span><span class="p">,</span> <span class="n">struct_</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">type_data</span><span class="p">,</span> <span class="n">meminfo_p</span> <span class="o">=</span> <span class="n">meminfo</span>
        <span class="k">return</span> <span class="n">cgutils_is_not_null</span><span class="p">(</span><span class="n">builder</span><span class="p">,</span> <span class="n">meminfo_p</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">boolean</span><span class="p">(</span><span class="n">struct_ty</span><span class="p">),</span> <span class="n">codegen</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_new</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">builder</span><span class="p">,</span> <span class="n">struct_ty_</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is essentially</span>
<span class="sd">     `numba new &lt;https://github.com/numba/numba/blob/release0.61/numba/experimental/structref.py#L301&gt;`_</span>

<span class="sd">    Returns structref (structure with one member being pointer to its meminfo) and the pointer to its payload.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">data_model_manager</span><span class="p">[</span><span class="n">struct_ty_</span><span class="o">.</span><span class="n">get_data_type</span><span class="p">()]</span>
    <span class="n">alloc_type</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_value_type</span><span class="p">()</span>
    <span class="n">alloc_size</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get_abi_sizeof</span><span class="p">(</span><span class="n">alloc_type</span><span class="p">)</span>
    <span class="n">meminfo</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">nrt</span><span class="o">.</span><span class="n">meminfo_alloc_dtor</span><span class="p">(</span>
        <span class="n">builder</span><span class="p">,</span>
        <span class="n">context</span><span class="o">.</span><span class="n">get_constant</span><span class="p">(</span><span class="n">uintp</span><span class="p">,</span> <span class="n">alloc_size</span><span class="p">),</span>
        <span class="n">imp_dtor</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">builder</span><span class="o">.</span><span class="n">module</span><span class="p">,</span> <span class="n">struct_ty_</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">data_pointer</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">nrt</span><span class="o">.</span><span class="n">meminfo_data</span><span class="p">(</span><span class="n">builder</span><span class="p">,</span> <span class="n">meminfo</span><span class="p">)</span>
    <span class="n">data_pointer</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">bitcast</span><span class="p">(</span><span class="n">data_pointer</span><span class="p">,</span> <span class="n">alloc_type</span><span class="o">.</span><span class="n">as_pointer</span><span class="p">())</span>
    <span class="c1"># builder.store(get_null_value(alloc_type), data_pointer)</span>
    <span class="n">work_</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">make_helper</span><span class="p">(</span><span class="n">builder</span><span class="p">,</span> <span class="n">struct_ty_</span><span class="p">)</span>
    <span class="n">work_</span><span class="o">.</span><span class="n">meminfo</span> <span class="o">=</span> <span class="n">meminfo</span>
    <span class="k">return</span> <span class="n">work_</span><span class="o">.</span><span class="n">_getvalue</span><span class="p">(),</span> <span class="n">data_pointer</span>


<div class="viewcode-block" id="populate_structref">
<a class="viewcode-back" href="../../../numbox.utils.html#numbox.utils.lowlevel.populate_structref">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">populate_structref</span><span class="p">(</span>
    <span class="n">context</span><span class="p">,</span> <span class="n">builder</span><span class="p">,</span> <span class="n">signature</span><span class="p">,</span> <span class="n">structref_type_</span><span class="p">,</span> <span class="n">structref_</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">ordered_args_names</span><span class="p">,</span> <span class="n">decref_old</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Store `args` with the corresponding ordered names `ordered_args_names`</span>
<span class="sd">    in structref with type `structref_type_` and payload at `data_pointer`.</span>

<span class="sd">    Based on numba.experimental.structref::define_attributes::struct_setattr_impl</span>

<span class="sd">    Do not call `decref_old` when populating a newly-created structref, as there&#39;s nothing to decref there.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">field_dict</span> <span class="o">=</span> <span class="n">structref_type_</span><span class="o">.</span><span class="n">field_dict</span>

    <span class="n">utils</span> <span class="o">=</span> <span class="n">_Utils</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">builder</span><span class="p">,</span> <span class="n">structref_type_</span><span class="p">)</span>
    <span class="n">dataval</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_data_struct</span><span class="p">(</span><span class="n">structref_</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">arg_i</span><span class="p">,</span> <span class="p">(</span><span class="n">arg_name</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">ordered_args_names</span><span class="p">,</span> <span class="n">args</span><span class="p">)):</span>
        <span class="n">arg_ty</span> <span class="o">=</span> <span class="n">signature</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="n">arg_i</span><span class="p">]</span>
        <span class="n">field_type</span> <span class="o">=</span> <span class="n">field_dict</span><span class="p">[</span><span class="n">arg_name</span><span class="p">]</span>
        <span class="n">casted</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">builder</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">arg_ty</span><span class="p">,</span> <span class="n">field_type</span><span class="p">)</span>
        <span class="n">old_value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">dataval</span><span class="p">,</span> <span class="n">arg_name</span><span class="p">)</span>
        <span class="n">context</span><span class="o">.</span><span class="n">nrt</span><span class="o">.</span><span class="n">incref</span><span class="p">(</span><span class="n">builder</span><span class="p">,</span> <span class="n">arg_ty</span><span class="p">,</span> <span class="n">casted</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">decref_old</span><span class="p">:</span>
            <span class="n">context</span><span class="o">.</span><span class="n">nrt</span><span class="o">.</span><span class="n">decref</span><span class="p">(</span><span class="n">builder</span><span class="p">,</span> <span class="n">arg_ty</span><span class="p">,</span> <span class="n">old_value</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">dataval</span><span class="p">,</span> <span class="n">arg_name</span><span class="p">,</span> <span class="n">casted</span><span class="p">)</span></div>



<span class="nd">@intrinsic</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_tuple_of_struct_ptrs_as_int</span><span class="p">(</span><span class="n">typingctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span> <span class="n">tup_ty</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Prefer using `_uniformize_tuple_of_structs` instead, if possible at all,</span>
<span class="sd">     to outsource smart pointer memory management to StructRef erased/void type. &quot;&quot;&quot;</span>
    <span class="n">tup_size</span> <span class="o">=</span> <span class="n">tup_ty</span><span class="o">.</span><span class="n">count</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">codegen</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">builder</span><span class="p">,</span> <span class="n">signature</span><span class="p">,</span> <span class="n">arguments</span><span class="p">):</span>
        <span class="n">array_values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">tup</span> <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">tup_ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tup_size</span><span class="p">):</span>
            <span class="n">tup_item</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">extract_value</span><span class="p">(</span><span class="n">tup</span><span class="p">,</span> <span class="n">tup_ind</span><span class="p">)</span>
            <span class="n">tup_item_meminfo</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">nrt</span><span class="o">.</span><span class="n">get_meminfos</span><span class="p">(</span><span class="n">builder</span><span class="p">,</span> <span class="n">tup_ty</span><span class="p">[</span><span class="n">tup_ind</span><span class="p">],</span> <span class="n">tup_item</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">tup_item_meminfo_p</span> <span class="o">=</span> <span class="n">tup_item_meminfo</span>
            <span class="n">tup_item_p_as_int</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">ptrtoint</span><span class="p">(</span><span class="n">tup_item_meminfo_p</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">get_data_type</span><span class="p">(</span><span class="n">intp</span><span class="p">))</span>
            <span class="n">array_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tup_item_p_as_int</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pack_array</span><span class="p">(</span><span class="n">builder</span><span class="p">,</span> <span class="n">array_values</span><span class="p">)</span>
    <span class="n">ret_type</span> <span class="o">=</span> <span class="n">UniTuple</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">tup_size</span><span class="p">)</span>
    <span class="n">sig</span> <span class="o">=</span> <span class="n">ret_type</span><span class="p">(</span><span class="n">tup_ty</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sig</span><span class="p">,</span> <span class="n">codegen</span>


<div class="viewcode-block" id="tuple_of_struct_ptrs_as_int">
<a class="viewcode-back" href="../../../numbox.utils.html#numbox.utils.lowlevel.tuple_of_struct_ptrs_as_int">[docs]</a>
<span class="nd">@njit</span><span class="p">(</span><span class="o">**</span><span class="n">default_jit_options</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">tuple_of_struct_ptrs_as_int</span><span class="p">(</span><span class="n">tup</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">_tuple_of_struct_ptrs_as_int</span><span class="p">(</span><span class="n">tup</span><span class="p">)</span></div>



<span class="nd">@intrinsic</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_uniformize_tuple_of_structs</span><span class="p">(</span><span class="n">typingctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span> <span class="n">tup_ty</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">uniform_ty_ref</span><span class="p">:</span> <span class="n">TypeRef</span><span class="p">):</span>
    <span class="n">tup_size</span> <span class="o">=</span> <span class="n">tup_ty</span><span class="o">.</span><span class="n">count</span>
    <span class="k">for</span> <span class="n">tup_ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tup_size</span><span class="p">):</span>
        <span class="n">item_ty</span> <span class="o">=</span> <span class="n">tup_ty</span><span class="p">[</span><span class="n">tup_ind</span><span class="p">]</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item_ty</span><span class="p">,</span> <span class="n">StructRef</span><span class="p">),</span> <span class="s2">&quot;Only Tuple of StructRef supported&quot;</span>
    <span class="n">uniform_ty</span> <span class="o">=</span> <span class="n">uniform_ty_ref</span><span class="o">.</span><span class="n">instance_type</span>
    <span class="n">ret_type</span> <span class="o">=</span> <span class="n">UniTuple</span><span class="p">(</span><span class="n">uniform_ty</span><span class="p">,</span> <span class="n">tup_size</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">codegen</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">builder</span><span class="p">,</span> <span class="n">signature</span><span class="p">,</span> <span class="n">arguments</span><span class="p">):</span>
        <span class="n">array_values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">tup</span> <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">tup_ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tup_size</span><span class="p">):</span>
            <span class="n">tup_item</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">extract_value</span><span class="p">(</span><span class="n">tup</span><span class="p">,</span> <span class="n">tup_ind</span><span class="p">)</span>
            <span class="n">source_ty_ll</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get_data_type</span><span class="p">(</span><span class="n">tup_ty</span><span class="p">[</span><span class="n">tup_ind</span><span class="p">])</span>
            <span class="n">dest_ty_ll</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get_data_type</span><span class="p">(</span><span class="n">uniform_ty</span><span class="p">)</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">builder</span><span class="p">,</span> <span class="n">tup_item</span><span class="p">,</span> <span class="n">source_ty_ll</span><span class="p">,</span> <span class="n">dest_ty_ll</span><span class="p">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">nrt</span><span class="o">.</span><span class="n">incref</span><span class="p">(</span><span class="n">builder</span><span class="p">,</span> <span class="n">uniform_ty</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
            <span class="n">array_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pack_array</span><span class="p">(</span><span class="n">builder</span><span class="p">,</span> <span class="n">array_values</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">get_data_type</span><span class="p">(</span><span class="n">uniform_ty</span><span class="p">))</span>
    <span class="n">sig</span> <span class="o">=</span> <span class="n">ret_type</span><span class="p">(</span><span class="n">tup_ty</span><span class="p">,</span> <span class="n">uniform_ty_ref</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sig</span><span class="p">,</span> <span class="n">codegen</span>


<div class="viewcode-block" id="uniformize_tuple_of_structs">
<a class="viewcode-back" href="../../../numbox.utils.html#numbox.utils.lowlevel.uniformize_tuple_of_structs">[docs]</a>
<span class="nd">@njit</span><span class="p">(</span><span class="o">**</span><span class="n">default_jit_options</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">uniformize_tuple_of_structs</span><span class="p">(</span><span class="n">tup</span><span class="p">,</span> <span class="n">uniform_ty</span><span class="o">=</span><span class="n">VoidType</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">_uniformize_tuple_of_structs</span><span class="p">(</span><span class="n">tup</span><span class="p">,</span> <span class="n">uniform_ty</span><span class="p">)</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Mikhail Goykhman.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>
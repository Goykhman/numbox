

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>numbox.core.variable.variable &mdash; numbox  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/css/theme.css?v=9edc463e" />

  
    <link rel="canonical" href="https://goykhman.github.io/numbox/_modules/numbox/core/variable/variable.html" />
      <script src="../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../index.html" class="icon icon-home">
            numbox
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../modules.html">numbox</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">numbox</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">numbox.core.variable.variable</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for numbox.core.variable.variable</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Iterator</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">,</span>
    <span class="n">Protocol</span><span class="p">,</span> <span class="n">TypeAlias</span><span class="p">,</span> <span class="n">TypedDict</span>
<span class="p">)</span>


<div class="viewcode-block" id="Namespace">
<a class="viewcode-back" href="../../../../numbox.core.variable.html#numbox.core.variable.variable.Namespace">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Namespace</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">_variables</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;Variable&#39;</span><span class="p">]</span>

<div class="viewcode-block" id="Namespace.keys">
<a class="viewcode-back" href="../../../../numbox.core.variable.html#numbox.core.variable.variable.Namespace.keys">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_variables</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span></div>


<div class="viewcode-block" id="Namespace.update">
<a class="viewcode-back" href="../../../../numbox.core.variable.html#numbox.core.variable.variable.Namespace.update">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">var</span><span class="p">:</span> <span class="s1">&#39;Variable&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Post-initialization update for dynamically generated</span>
<span class="sd">        `Variable`s.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_variables</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">var</span></div>


    <span class="k">def</span><span class="w"> </span><span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param key: un-qualified name of the `Variable`</span>
<span class="sd">        It is qualified with `self.name` - the name of this</span>
<span class="sd">        `Namespace` namespace that the `Variable` belongs to.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_variables</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Variable&#39;</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_variables</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span></div>



<div class="viewcode-block" id="Storage">
<a class="viewcode-back" href="../../../../numbox.core.variable.html#numbox.core.variable.variable.Storage">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Storage</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="n">_values</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="s1">&#39;Variable&#39;</span><span class="p">,</span> <span class="s1">&#39;Value&#39;</span><span class="p">]</span>
    <span class="n">cache</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="s1">&#39;Variable&#39;</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="o">...</span><span class="p">]],</span> <span class="s1">&#39;VarValue&#39;</span><span class="p">]</span>

<div class="viewcode-block" id="Storage.get">
<a class="viewcode-back" href="../../../../numbox.core.variable.html#numbox.core.variable.variable.Storage.get">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variable</span><span class="p">:</span> <span class="s1">&#39;Variable&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Value&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Principal access point to the requested variable.</span>
<span class="sd">        Instantiates the corresponding value when first</span>
<span class="sd">        invoked for the given variable.</span>
<span class="sd">        &quot;&quot;&quot;</span></div>


    <span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="s1">&#39;Variable&#39;</span><span class="p">]:</span>
        <span class="k">pass</span></div>



<div class="viewcode-block" id="VarSpec">
<a class="viewcode-back" href="../../../../numbox.core.variable.html#numbox.core.variable.variable.VarSpec">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">VarSpec</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">inputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>
    <span class="n">formula</span><span class="p">:</span> <span class="n">Callable</span>
    <span class="n">metadata</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">cacheable</span><span class="p">:</span> <span class="nb">bool</span></div>



<span class="n">VarValue</span><span class="p">:</span> <span class="n">TypeAlias</span> <span class="o">=</span> <span class="n">Any</span>


<span class="k">class</span><span class="w"> </span><span class="nc">_Null</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Value of `Variable` that has not been calculated. &quot;&quot;&quot;</span>
    <span class="k">pass</span>


<span class="n">_null</span> <span class="o">=</span> <span class="n">_Null</span><span class="p">()</span>


<span class="n">QUAL_SEP</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span>


<div class="viewcode-block" id="make_qual_name">
<a class="viewcode-back" href="../../../../numbox.core.variable.html#numbox.core.variable.variable.make_qual_name">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">make_qual_name</span><span class="p">(</span><span class="n">namespace_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">var_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Each `Variable` instance is best initialized in</span>
<span class="sd">    and owned by a `Namespace` object (such as, instances</span>
<span class="sd">    of `External` and `Variables`), with the given</span>
<span class="sd">    `namespace_name`.</span>

<span class="sd">    This function thereby returns qualified name of the</span>
<span class="sd">    `Variable` instance. &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">namespace_name</span><span class="si">}{</span><span class="n">QUAL_SEP</span><span class="si">}{</span><span class="n">var_name</span><span class="si">}</span><span class="s2">&quot;</span></div>



<div class="viewcode-block" id="External">
<a class="viewcode-back" href="../../../../numbox.core.variable.html#numbox.core.variable.variable.External">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">External</span><span class="p">(</span><span class="n">Namespace</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An &#39;external&#39; namespace that facilitates discovery</span>
<span class="sd">    of requested names.</span>

<span class="sd">    When requesting a `Variable` with the given name via a</span>
<span class="sd">    typical `__getitem__` call, if the `Variable` is not</span>
<span class="sd">    found, it will be created and added to this dictionary.</span>
<span class="sd">    This way the graph will be able to infer which variables</span>
<span class="sd">    are required from the external source abstracted by this</span>
<span class="sd">    namespace.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_variables</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;Variable&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Variable&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param name: un-qualified name of the `Variable`.</span>
<span class="sd">        Instances of `Variable` that are &#39;external&#39; should</span>
<span class="sd">        be put in `External` namespace indirectly, through</span>
<span class="sd">        a call to this method. These `Variable`s will be</span>
<span class="sd">        qualified with the name `self.name` of this namespace.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">variable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_variables</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">variable</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">variable</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                <span class="n">source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_variables</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">variable</span>
        <span class="k">return</span> <span class="n">variable</span></div>



<div class="viewcode-block" id="Variable">
<a class="viewcode-back" href="../../../../numbox.core.variable.html#numbox.core.variable.variable.Variable">[docs]</a>
<span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Variable</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An instance of `Variable` is anything that can be calculated</span>
<span class="sd">    from the values of the given `inputs` dependencies using the</span>
<span class="sd">    provided `formula` (i.e., a Python function).</span>

<span class="sd">    Calculated value can be `None`, that is why a non-calculated</span>
<span class="sd">    value is designated with `_null`.</span>

<span class="sd">    An instance of `Variable` is best created within the given</span>
<span class="sd">    `Namespace`. For example, when the `Variables` subtype of</span>
<span class="sd">    the `Namespace` is instantiated, it gets populated with</span>
<span class="sd">    the freshly created `Variable` instances per the `VarSpec`</span>
<span class="sd">    specifications passed to it. Or, when the `External` subtype</span>
<span class="sd">    of the `Namespace` is queried for the given variable name,</span>
<span class="sd">    if a `Variable` with such a name is not already present in</span>
<span class="sd">    that external namespace, it will be created and stored there.</span>

<span class="sd">    :param name: name of the `Variable` instance.</span>
<span class="sd">    :param source: name of the `Namespace` instance  which is</span>
<span class="sd">    the namespace / source of this `Variable`.</span>
<span class="sd">    :param inputs: (optional) map from names of the `Variable`</span>
<span class="sd">    inputs (which are names of other `Variable` instances) to</span>
<span class="sd">    names of their `Namespace`s.</span>
<span class="sd">    :param formula: (optional) function that calculates the</span>
<span class="sd">    value of this `Variable` from its sources.</span>
<span class="sd">    :param metadata: any possible metadata associated with</span>
<span class="sd">    this variable.</span>
<span class="sd">    :param cacheable: (default `False`) when `True`, the</span>
<span class="sd">    corresponding `Value` (see below) will be cached during</span>
<span class="sd">    calculation. When attempting to recompute with the same</span>
<span class="sd">    inputs, cached value will be returned instead. Use sparingly!</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">source</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">inputs</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="p">{})</span>
    <span class="n">formula</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">metadata</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">cacheable</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Variable</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">name</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">source</span>

<div class="viewcode-block" id="Variable.qual_name">
<a class="viewcode-back" href="../../../../numbox.core.variable.html#numbox.core.variable.variable.Variable.qual_name">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">qual_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Qualified name of `Variable` incorporates both the name</span>
<span class="sd">        of the `Variable` and the name of its source / namespace.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">make_qual_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="Variables">
<a class="viewcode-back" href="../../../../numbox.core.variable.html#numbox.core.variable.variable.Variables">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Variables</span><span class="p">(</span><span class="n">Namespace</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">variables</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">VarSpec</span><span class="p">],</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Namespace of `Variable` instances.</span>

<span class="sd">        :param name: name of the `Variables` instance namespace.</span>
<span class="sd">        :param variables: initializer list of `VarSpec` specs</span>
<span class="sd">        used to create instances of `Variable` to be stored in</span>
<span class="sd">        this namespace.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_variables</span> <span class="o">=</span> <span class="p">{</span><span class="n">variable</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]:</span> <span class="n">Variable</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">variable</span><span class="p">)</span> <span class="k">for</span> <span class="n">variable</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variable_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Variable</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param variable_name: name of the `Variable` to retrieve.</span>
<span class="sd">        This is un-qualified name, as it is already looked up in</span>
<span class="sd">        this namespace.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_variables</span><span class="p">[</span><span class="n">variable_name</span><span class="p">]</span></div>



<div class="viewcode-block" id="Value">
<a class="viewcode-back" href="../../../../numbox.core.variable.html#numbox.core.variable.variable.Value">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Value</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Value of the corresponding `Variable`.</span>
<span class="sd">    Best used when created indirectly by the</span>
<span class="sd">    `Values` storage.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">variable</span><span class="p">:</span> <span class="n">Variable</span>
    <span class="n">value</span><span class="p">:</span> <span class="n">VarValue</span> <span class="o">|</span> <span class="n">_Null</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">_null</span><span class="p">)</span></div>



<div class="viewcode-block" id="Values">
<a class="viewcode-back" href="../../../../numbox.core.variable.html#numbox.core.variable.variable.Values">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Values</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Values of all `Variable`s, computed and external,</span>
<span class="sd">    will be held here. &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_values</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Variable</span><span class="p">,</span> <span class="n">Value</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="s1">&#39;Variable&#39;</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="o">...</span><span class="p">]],</span> <span class="n">VarValue</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

<div class="viewcode-block" id="Values.get">
<a class="viewcode-back" href="../../../../numbox.core.variable.html#numbox.core.variable.variable.Values.get">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variable</span><span class="p">:</span> <span class="n">Variable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Value</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">variable</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_values</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_values</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span> <span class="o">=</span> <span class="n">Value</span><span class="p">(</span><span class="n">variable</span><span class="o">=</span><span class="n">variable</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_values</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span></div>


    <span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Variable</span><span class="p">]:</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_values</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span></div>



<div class="viewcode-block" id="CompiledNode">
<a class="viewcode-back" href="../../../../numbox.core.variable.html#numbox.core.variable.variable.CompiledNode">[docs]</a>
<span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">CompiledNode</span><span class="p">:</span>
    <span class="n">variable</span><span class="p">:</span> <span class="n">Variable</span>
    <span class="n">inputs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Variable</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">variable</span><span class="o">.</span><span class="n">formula</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">variable</span><span class="o">.</span><span class="n">inputs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">variable</span><span class="si">}</span><span class="s2"> contains formula but no inputs, how come?&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">variable</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">CompiledNode</span><span class="p">)</span> <span class="ow">and</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">variable</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">variable</span><span class="o">.</span><span class="n">name</span> <span class="ow">and</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">variable</span><span class="o">.</span><span class="n">source</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">variable</span><span class="o">.</span><span class="n">source</span>
        <span class="p">)</span></div>



<div class="viewcode-block" id="CompiledGraph">
<a class="viewcode-back" href="../../../../numbox.core.variable.html#numbox.core.variable.variable.CompiledGraph">[docs]</a>
<span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">CompiledGraph</span><span class="p">:</span>
    <span class="n">ordered_nodes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">CompiledNode</span><span class="p">]</span>
    <span class="n">required_external_variables</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Variable</span><span class="p">]]</span>
    <span class="n">dependents</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Variable</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">CompiledNode</span><span class="p">]]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="p">{})</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ordered_nodes</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">inp</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">inputs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dependents</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

<div class="viewcode-block" id="CompiledGraph.execute">
<a class="viewcode-back" href="../../../../numbox.core.variable.html#numbox.core.variable.variable.CompiledGraph.execute">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">external_values</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">VarValue</span><span class="p">]],</span>
        <span class="n">values</span><span class="p">:</span> <span class="n">Storage</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Main entry point to calculate values of nodes of the compiled</span>
<span class="sd">        graph. Calculation requires the following inputs:</span>

<span class="sd">        :param external_values: actual values of all required external</span>
<span class="sd">        variables, this can be a superset of what is really needed for</span>
<span class="sd">        the calculation. The map is first from the name of the external</span>
<span class="sd">        namespace and then from the name of the variable within that</span>
<span class="sd">        source to the variable&#39;s actual value.</span>
<span class="sd">        :param values: runtime storage of all values, e.g., an instance</span>
<span class="sd">        of `Values`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assign_external_values</span><span class="p">(</span><span class="n">external_values</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calculate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ordered_nodes</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_assign_external_values</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">external_values</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">VarValue</span><span class="p">]],</span>
        <span class="n">values</span><span class="p">:</span> <span class="n">Storage</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        For the external variables required for this calculation,</span>
<span class="sd">        populate their values into the `Values` storage.</span>

<span class="sd">        :param external_values: mapping from names of external sources</span>
<span class="sd">        to dictionary from names of external `Variable`s to their values</span>
<span class="sd">        that are needed for the given calculation.</span>
<span class="sd">        :param values: an instance of `Values` storage of all calculated</span>
<span class="sd">        values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">source_name</span><span class="p">,</span> <span class="n">variables</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">required_external_variables</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">provided</span> <span class="o">=</span> <span class="n">external_values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">source_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">provided</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing external source &#39;</span><span class="si">{</span><span class="n">source_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">variable</span> <span class="ow">in</span> <span class="n">variables</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">var_value</span> <span class="o">=</span> <span class="n">provided</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">var_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">var_value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Missing value for external variable &#39;</span><span class="si">{</span><span class="n">make_qual_name</span><span class="p">(</span><span class="n">source_name</span><span class="p">,</span><span class="w"> </span><span class="n">var_name</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                    <span class="p">)</span>
                <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">variable</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">var_value</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_collect_affected</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">changed_vars</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">Variable</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">CompiledNode</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return subset of `self.ordered_nodes` consisting of nodes</span>
<span class="sd">        affected by `changed_vars`, in the same order as in the</span>
<span class="sd">        `self.ordered_nodes`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">affected</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">stack</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">changed_vars</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">stack</span><span class="p">:</span>
            <span class="n">var</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependents</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="p">[]):</span>
                <span class="k">if</span> <span class="n">node</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">affected</span><span class="p">:</span>
                    <span class="n">affected</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
                    <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">variable</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">node</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ordered_nodes</span> <span class="k">if</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">affected</span><span class="p">]</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate</span><span class="p">(</span><span class="n">nodes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">CompiledNode</span><span class="p">],</span> <span class="n">values</span><span class="p">:</span> <span class="n">Storage</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the values of the `Variable`s using their own `formula`</span>
<span class="sd">        by evaluating them as functions of the values of the specified</span>
<span class="sd">        inputs.</span>

<span class="sd">        All inputs need to be calculated first (i.e., to be non-`_null`)</span>
<span class="sd">        before the value of the given `Variable` can be `_calculate`d.</span>
<span class="sd">        This is possible because the `Variable`s in the list `nodes` are</span>
<span class="sd">        supplied as a topologically ordered list `self.ordered_variables`,</span>
<span class="sd">        or as an ordered sub-set thereof (see, e.g., `recompute`).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">variable</span><span class="o">.</span><span class="n">formula</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">args</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">input_</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">input_</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">inputs</span><span class="p">)</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span>
                <span class="p">[</span><span class="n">arg</span> <span class="ow">is</span> <span class="n">_null</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">]</span>
            <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;Uninitialized input for </span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">variable</span><span class="si">}</span><span class="s2">, args = </span><span class="si">{</span><span class="n">args</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">cache_key</span> <span class="o">=</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">variable</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">variable</span><span class="o">.</span><span class="n">cacheable</span> <span class="ow">and</span> <span class="n">cache_key</span> <span class="ow">in</span> <span class="n">values</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
                <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">variable</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span>
                <span class="k">continue</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">variable</span><span class="o">.</span><span class="n">formula</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">variable</span><span class="o">.</span><span class="n">cacheable</span><span class="p">:</span>
                <span class="n">values</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
            <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">variable</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">result</span>

<div class="viewcode-block" id="CompiledGraph.recompute">
<a class="viewcode-back" href="../../../../numbox.core.variable.html#numbox.core.variable.variable.CompiledGraph.recompute">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">recompute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">changed</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">VarValue</span><span class="p">]],</span> <span class="n">values</span><span class="p">:</span> <span class="n">Storage</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param changed: dict of sources to names to new values of changed</span>
<span class="sd">        `Variable`s coming from either `External` or `Variables` source.</span>
<span class="sd">        :param values: storage of all the `Variable` values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">changed_vars</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">src</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">changed</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">vals</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">variable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">required_external_variables</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="n">qual_name</span> <span class="o">=</span> <span class="n">make_qual_name</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">variable</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">variable</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">variable</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ordered_nodes</span> <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">variable</span><span class="o">.</span><span class="n">qual_name</span><span class="p">()</span> <span class="o">==</span> <span class="n">qual_name</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">qual_name</span><span class="si">}</span><span class="s2"> is not in the calculation path, update has no effect.&quot;</span><span class="p">)</span>
                        <span class="k">continue</span>
                <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">variable</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">val</span>
                <span class="n">changed_vars</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">variable</span><span class="p">)</span>
        <span class="n">affected_nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collect_affected</span><span class="p">(</span><span class="n">changed_vars</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">affected_nodes</span><span class="p">:</span>
            <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">variable</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">_null</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calculate</span><span class="p">(</span><span class="n">affected_nodes</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="Graph">
<a class="viewcode-back" href="../../../../numbox.core.variable.html#numbox.core.variable.variable.Graph">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Graph</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">variables_lists</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">VarSpec</span><span class="p">]],</span>
        <span class="n">external_source_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param variables_lists: mapping of names of `Variables`</span>
<span class="sd">        namespaces to the lists of `Variable` instances to be</span>
<span class="sd">        added to those namespaces.</span>
<span class="sd">        :param external_source_names: list of names of possible</span>
<span class="sd">        `External` sources from which `Variable` inputs might</span>
<span class="sd">        be coming from.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">external_source_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">external_source_names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Namespace</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">external</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">External</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">external_source_name</span><span class="p">:</span> <span class="n">External</span><span class="p">(</span><span class="n">external_source_name</span><span class="p">)</span> <span class="k">for</span> <span class="n">external_source_name</span> <span class="ow">in</span> <span class="n">external_source_names</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">variables_name</span><span class="p">,</span> <span class="n">variables_list</span> <span class="ow">in</span> <span class="n">variables_lists</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">variables</span> <span class="o">=</span> <span class="n">Variables</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">variables_name</span><span class="p">,</span>
                <span class="n">variables</span><span class="o">=</span><span class="n">variables_list</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="n">variables_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">variables</span>
        <span class="k">for</span> <span class="n">external_name</span><span class="p">,</span> <span class="n">external_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">external</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">external_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot use </span><span class="si">{</span><span class="n">external_name</span><span class="si">}</span><span class="s2"> for external, it&#39;s already used by variables_lists&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="n">external_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">external_</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compiled_graphs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reverse_dependencies</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="Graph.compile">
<a class="viewcode-back" href="../../../../numbox.core.variable.html#numbox.core.variable.variable.Graph.compile">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">compile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">required</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CompiledGraph</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :required: list of qualified variables names that need to be calculated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">required</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">required</span> <span class="o">=</span> <span class="p">[</span><span class="n">required</span><span class="p">]</span>
        <span class="n">required_tup</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">required</span><span class="p">))</span>
        <span class="n">compiled_graph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiled_graphs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">required_tup</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">compiled_graph</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">compiled_graph</span>
        <span class="n">ordered_variables</span><span class="p">,</span> <span class="n">used_external_vars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_topological_order</span><span class="p">(</span><span class="n">required</span><span class="p">)</span>
        <span class="n">ordered_nodes</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">CompiledNode</span><span class="p">(</span>
                <span class="n">variable</span><span class="o">=</span><span class="n">var</span><span class="p">,</span>
                <span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="n">var</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="n">input_name</span><span class="p">]][</span><span class="n">input_name</span><span class="p">]</span> <span class="k">for</span> <span class="n">input_name</span> <span class="ow">in</span> <span class="n">var</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
            <span class="p">)</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">ordered_variables</span>
        <span class="p">]</span>
        <span class="n">required_external_variables</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_required_external_variables</span><span class="p">(</span><span class="n">used_external_vars</span><span class="p">)</span>
        <span class="n">compiled</span> <span class="o">=</span> <span class="n">CompiledGraph</span><span class="p">(</span>
            <span class="n">ordered_nodes</span><span class="o">=</span><span class="n">ordered_nodes</span><span class="p">,</span>
            <span class="n">required_external_variables</span><span class="o">=</span><span class="n">required_external_variables</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compiled_graphs</span><span class="p">[</span><span class="n">required_tup</span><span class="p">]</span> <span class="o">=</span> <span class="n">compiled</span>
        <span class="k">return</span> <span class="n">compiled</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_get_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Namespace</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param source_name: name of the source (either an instance</span>
<span class="sd">        of `Variables` or an `External` source) that is requested.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">variables_source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">source_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">variables_source</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">variables_source</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown source </span><span class="si">{</span><span class="n">source_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_topological_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">required</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param required: qualified name(s) of `Variable` instance(s)</span>
<span class="sd">        for which a topological ordering of a DAG is to be determined.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">required</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">required</span> <span class="o">=</span> <span class="p">[</span><span class="n">required</span><span class="p">]</span>

        <span class="n">visited</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">visiting</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">ordered_variables</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">used_external_vars</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">Variable</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">visit</span><span class="p">(</span><span class="n">qual_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot; DFS traversal of graph nodes. &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">qual_name</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="n">qual_name</span> <span class="ow">in</span> <span class="n">visiting</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cycle detected at </span><span class="si">{</span><span class="n">qual_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">visiting</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">qual_name</span><span class="p">)</span>
            <span class="n">source_name</span><span class="p">,</span> <span class="n">variable_name</span> <span class="o">=</span> <span class="n">qual_name</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="n">QUAL_SEP</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_source</span><span class="p">(</span><span class="n">source_name</span><span class="p">)</span>
            <span class="n">variable</span> <span class="o">=</span> <span class="n">source</span><span class="p">[</span><span class="n">variable_name</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">External</span><span class="p">):</span>
                <span class="n">used_external_vars</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">variable</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">input_name</span><span class="p">,</span> <span class="n">input_source</span> <span class="ow">in</span> <span class="n">variable</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">visit</span><span class="p">(</span><span class="n">make_qual_name</span><span class="p">(</span><span class="n">input_source</span><span class="p">,</span> <span class="n">input_name</span><span class="p">))</span>
            <span class="n">visiting</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">qual_name</span><span class="p">)</span>
            <span class="n">visited</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">qual_name</span><span class="p">)</span>
            <span class="n">ordered_variables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">variable</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">required</span><span class="p">:</span>
            <span class="n">visit</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ordered_variables</span><span class="p">,</span> <span class="n">used_external_vars</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_required_external_variables</span><span class="p">(</span><span class="n">used_external_vars</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">Variable</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Variable</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        For requested `External` sources, return the list of required</span>
<span class="sd">        external `Variable` instances.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">required_external_variables</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">variable</span> <span class="ow">in</span> <span class="n">used_external_vars</span><span class="p">:</span>
            <span class="n">variable_name</span> <span class="o">=</span> <span class="n">variable</span><span class="o">.</span><span class="n">name</span>
            <span class="n">variable_source</span> <span class="o">=</span> <span class="n">variable</span><span class="o">.</span><span class="n">source</span>
            <span class="n">required_external_variables</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">variable_source</span><span class="p">,</span> <span class="p">{})[</span><span class="n">variable_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">variable</span>
        <span class="k">return</span> <span class="n">required_external_variables</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_build_reverse_dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Utility to calculate set of qualified names of variables</span>
<span class="sd">        impacted by each of the encountered inputs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reverse_dependencies</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reverse_dependencies</span>
        <span class="n">reverse</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">source_name</span><span class="p">,</span> <span class="n">source</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">variable_name</span> <span class="ow">in</span> <span class="n">source</span><span class="p">:</span>
                <span class="n">variable</span> <span class="o">=</span> <span class="n">source</span><span class="p">[</span><span class="n">variable_name</span><span class="p">]</span>
                <span class="n">qual_name</span> <span class="o">=</span> <span class="n">make_qual_name</span><span class="p">(</span><span class="n">source_name</span><span class="p">,</span> <span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">input_name</span><span class="p">,</span> <span class="n">input_source</span> <span class="ow">in</span> <span class="n">variable</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">input_qual</span> <span class="o">=</span> <span class="n">make_qual_name</span><span class="p">(</span><span class="n">input_source</span><span class="p">,</span> <span class="n">input_name</span><span class="p">)</span>
                    <span class="n">reverse</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">input_qual</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">qual_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reverse_dependencies</span> <span class="o">=</span> <span class="n">reverse</span>
        <span class="k">return</span> <span class="n">reverse</span>

<div class="viewcode-block" id="Graph.dependents_of">
<a class="viewcode-back" href="../../../../numbox.core.variable.html#numbox.core.variable.variable.Graph.dependents_of">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">dependents_of</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qual_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return qualified names of `Variable`s that directly or indirectly</span>
<span class="sd">        depend on any of `qual_names`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">qual_names</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">qual_names</span> <span class="o">=</span> <span class="p">{</span><span class="n">qual_names</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">qual_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">qual_names</span><span class="p">)</span>
        <span class="n">reverse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_reverse_dependencies</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">qual_names</span><span class="p">)</span>
        <span class="n">stack</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">qual_names</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">stack</span><span class="p">:</span>
            <span class="n">current</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">reverse</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="p">()):</span>
                <span class="k">if</span> <span class="n">dep</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dep</span><span class="p">)</span>
                    <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dep</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="Graph.explain">
<a class="viewcode-back" href="../../../../numbox.core.variable.html#numbox.core.variable.variable.Graph.explain">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">explain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qual_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">right_to_left</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Follow the dependencies chain to explain how the given</span>
<span class="sd">        variable is derived.</span>

<span class="sd">        Uses `metadata` of the `Variable` instances.</span>

<span class="sd">        :param qual_name: qualified name of the `Variable`.</span>
<span class="sd">        :param right_to_left: when `True` (default), begin explanation</span>
<span class="sd">        with `qual_name`. That is, move towards the ends of the</span>
<span class="sd">        graph.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">derived</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">derivation</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">collect</span><span class="p">(</span><span class="n">qual_name_</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">qual_name_</span> <span class="ow">in</span> <span class="n">derived</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">derived</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">qual_name_</span><span class="p">)</span>
            <span class="n">source_name</span><span class="p">,</span> <span class="n">variable_name</span> <span class="o">=</span> <span class="n">qual_name_</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">QUAL_SEP</span><span class="p">)</span>
            <span class="n">variable_source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="n">source_name</span><span class="p">]</span>
            <span class="n">variable</span> <span class="o">=</span> <span class="n">variable_source</span><span class="p">[</span><span class="n">variable_name</span><span class="p">]</span>
            <span class="n">inputs_qual_names</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">input_name</span><span class="p">,</span> <span class="n">input_source</span> <span class="ow">in</span> <span class="n">variable</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">inputs_qual_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">make_qual_name</span><span class="p">(</span><span class="n">input_source</span><span class="p">,</span> <span class="n">input_name</span><span class="p">))</span>
                <span class="n">collect</span><span class="p">(</span><span class="n">make_qual_name</span><span class="p">(</span><span class="n">input_source</span><span class="p">,</span> <span class="n">input_name</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">variable_source</span><span class="p">,</span> <span class="n">External</span><span class="p">):</span>
                <span class="n">derivation</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">variable_name</span><span class="si">}</span><span class="s2">&#39; comes from external source &#39;</span><span class="si">{</span><span class="n">source_name</span><span class="si">}</span><span class="s2">&#39;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">derivation</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;&quot;&quot;&#39;</span><span class="si">{</span><span class="n">qual_name_</span><span class="si">}</span><span class="s2">&#39; depends on </span><span class="si">{</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">inputs_qual_names</span><span class="p">))</span><span class="si">}</span><span class="s2"> via </span><span class="se">\n\n</span><span class="si">{</span><span class="n">variable</span><span class="o">.</span><span class="n">metadata</span><span class="si">}</span><span class="s2">&quot;&quot;&quot;</span>
                <span class="p">)</span>

        <span class="n">collect</span><span class="p">(</span><span class="n">qual_name</span><span class="p">)</span>
        <span class="n">derivation</span> <span class="o">=</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">derivation</span><span class="p">)</span> <span class="k">if</span> <span class="n">right_to_left</span> <span class="k">else</span> <span class="n">derivation</span>
        <span class="n">derivation_txt</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">derivation</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">derivation_txt</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Mikhail Goykhman.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>